<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Woody 16Âºµ - Á¥îÊ∑®ÊâãÂãïÁâà</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --mj-bg: #0c330c; --tile-face: #fdfdfd; --tile-back: #1a5e1a; --text-red: #d32f2f; --text-blue: #1976d2; --text-green: #2e7d32; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--mj-bg); overflow: hidden; touch-action: none; position: fixed; font-family: "Microsoft JhengHei", sans-serif; }
        #lobby { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .lobby-box { background: white; color: black; padding: 20px; border-radius: 15px; text-align: center; width: 280px; }
        .input-field { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }
        #status-bar { height: 5vh; background: #000; color: #0f0; font-size: 12px; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        .table { width: 100%; height: 70vh; background: #1b4d1b; display: flex; flex-wrap: wrap; align-content: flex-start; padding: 10px; overflow-y: auto; border-bottom: 2px solid #5d4037; box-sizing: border-box; }
        .hand-area { width: 100%; height: 25vh; background: linear-gradient(to top, #000, rgba(0,0,0,0.9)); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .tile { width: 34px; height: 48px; background: var(--tile-face); border-radius: 4px; margin: 1.5px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 2px 0 var(--tile-back); flex-shrink: 0; cursor: pointer; }
        .selected { transform: translateY(-18px) !important; box-shadow: 0 8px 20px gold !important; border: 2px solid #fff; z-index: 10; }
        .tile-content { display: flex; flex-direction: column; align-items: center; line-height: 1.1; pointer-events: none; }
        .char-top { font-size: 17px; font-weight: bold; }
        .char-bottom { font-size: 9px; }
        .c-red { color: var(--text-red); }
        .c-blue { color: var(--text-blue); }
        .c-green { color: var(--text-green); }
        #action-bar { position: absolute; top: -45px; display: flex; gap: 8px; width: 100%; justify-content: center; }
        .btn-act { padding: 6px 12px; border-radius: 4px; border: none; font-weight: bold; color: white; background: #e67e22; font-size: 12px; }
        .btn-auto-sort { background: #27ae60; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="lobby-box">
        <h3>üÄÑ Woody È∫ªÂ∞á (ÁÑ°ÊåâÈàïË£úËä±Áâà)</h3>
        <input type="text" id="userName" class="input-field" placeholder="ÂßìÂêç">
        <button onclick="startMode('single')" style="width:100%; padding:10px; background:#27ae60; color:white; border:none; border-radius:8px; margin-bottom:10px;">ÂñÆÊ©ü</button>
        <input type="text" id="roomInput" class="input-field" placeholder="ÊàøËôü">
        <button onclick="startMode('multi')" style="width:100%; padding:10px; background:#2980b9; color:white; border:none; border-radius:8px;">ËÅØÊ©ü</button>
    </div>
</div>

<div id="game-ui" style="display:none">
    <div id="status-bar"><div id="info-wall">ÁâÜ: --</div><div id="info-turn">--</div><div id="info-tip" style="color:#0af;">ÈªûÊìäËä±ÁâåÂç≥Ë£úËä±</div></div>
    <div class="table" id="pool"></div>
    <div class="hand-area">
        <div id="action-bar"></div>
        <div class="hand" id="my-hand" style="display:flex;"></div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "YOUR_KEY", databaseURL: "YOUR_URL", projectId: "YOUR_ID" };
    let db; try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch(e) {}

    let myTiles=[], wall=[], pool=[], myRole="P1", roomID="", myName="", isMulti=false, selectedIdx=null, gameState={};

    function startMode(mode) {
        myName = document.getElementById('userName').value || "Áé©ÂÆ∂";
        isMulti = (mode === 'multi');
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        if (isMulti) initMulti(); else initSingle();
    }

    function createDeck() {
        const suits = ["Ëê¨", "Á≠í", "Ê¢ù"], nums = ["‰∏Ä", "‰∫å", "‰∏â", "Âõõ", "‰∫î", "ÂÖ≠", "‰∏É", "ÂÖ´", "‰πù"], honors = ["Êù±", "Âçó", "Ë•ø", "Âåó", "‰∏≠", "Áôº", "ÁôΩ"], flowers = ["Êò•", "Â§è", "Áßã", "ÂÜ¨", "Ê¢Ö", "Ëò≠", "Á´π", "Ëèä"];
        let d = [];
        suits.forEach(s => nums.forEach(n => { for(let i=0; i<4; i++) d.push({n, s}); }));
        honors.forEach(h => { for(let i=0; i<4; i++) d.push({n: h, s: "Â≠ó"}); });
        flowers.forEach(f => d.push({n: f, s: "Ëä±"}));
        return d.sort(() => Math.random() - 0.5);
    }

    function initSingle() {
        wall = createDeck(); myTiles = wall.splice(0, 16);
        gameState = { wall, pool: [], turnIdx: 0, phase: "draw", p1_n: myName, p1_tiles: myTiles };
        updateUI();
    }

    async function initMulti() {
        roomID = document.getElementById('roomInput').value;
        const ref = db.ref('rooms/' + roomID);
        const snap = await ref.once('value');
        if (!snap.exists()) {
            myRole="P1"; const d=createDeck();
            await ref.set({ wall: d, pool: [], turnIdx: 0, phase: "draw", p1_n: myName, p1_tiles: d.splice(0,16) });
        } else {
            myRole="P2";
            if (!snap.val().p2_tiles) {
                const w = snap.val().wall;
                await ref.update({ p2_n: myName, p2_tiles: w.splice(0,16), wall: w });
            }
        }
        ref.on('value', s => { gameState = s.val(); syncData(); updateUI(); });
    }

    function syncData() {
        myTiles = gameState[myRole.toLowerCase() + '_tiles'] || [];
        pool = gameState.pool || []; wall = gameState.wall || [];
    }

    function updateUI() {
        document.getElementById('info-wall').innerText = `ÁâÜ: ${wall.length}`;
        document.getElementById('info-turn').innerText = (gameState.turnIdx === 0) ? "Âà∞‰Ω†‰∫Ü" : "Á≠âÂæÖ‰∏≠";
        const bar = document.getElementById('action-bar'); bar.innerHTML = "";
        addBtn("Ëá™ÂãïÁêÜÁâå", autoSort, "btn-auto-sort");
        if (gameState.turnIdx === 0 && gameState.phase === "draw") addBtn("Êë∏Áâå", drawTile);
        renderHand(); renderPool();
    }

    function handleTileClick(i) {
        const clickedTile = myTiles[i];

        // ÂäüËÉΩÔºöÈªûÊìäËä±ÁâåÁ´ãÂç≥Ë£úËä±
        if (clickedTile.s === "Ëä±") {
            pool.push(myTiles.splice(i, 1)[0]);
            myTiles.push(wall.pop());
            selectedIdx = null;
            updateGame({ pool, wall, [myRole.toLowerCase() + '_tiles']: myTiles });
            return;
        }

        if (selectedIdx === null) {
            selectedIdx = i;
        } else if (selectedIdx === i) {
            // Âá∫ÁâåÈÇèËºØ
            if (gameState.turnIdx === 0 && gameState.phase === "play") {
                pool.push(myTiles.splice(i, 1)[0]);
                selectedIdx = null;
                updateGame({ pool, turnIdx: 1, phase: "draw", [myRole.toLowerCase() + '_tiles']: myTiles });
                if (!isMulti) setTimeout(aiCycle, 800);
            } else { selectedIdx = null; }
        } else {
            // ÊèíÂÖ•ÂºèÁêÜÁâå
            const movedTile = myTiles.splice(selectedIdx, 1)[0];
            myTiles.splice(i, 0, movedTile);
            selectedIdx = null;
            updateGame({ [myRole.toLowerCase() + '_tiles']: myTiles });
        }
        updateUI();
    }

    function autoSort() {
        const sO = {"Ëä±":1,"Â≠ó":2,"Ëê¨":3,"Á≠í":4,"Ê¢ù":5}, nO = {"‰∏Ä":1,"‰∫å":2,"‰∏â":3,"Âõõ":4,"‰∫î":5,"ÂÖ≠":6,"‰∏É":7,"ÂÖ´":8,"‰πù":9,"Êù±":1,"Âçó":2,"Ë•ø":3,"Âåó":4,"‰∏≠":5,"Áôº":6,"ÁôΩ":7};
        myTiles.sort((a,b) => (sO[a.s]-sO[b.s]) || (nO[a.n]-nO[b.n]));
        updateGame({ [myRole.toLowerCase() + '_tiles']: myTiles });
    }

    function drawTile() {
        if (wall.length > 0) {
            myTiles.push(wall.shift());
            updateGame({ wall, phase: "play", [myRole.toLowerCase() + '_tiles']: myTiles });
        }
    }

    function aiCycle() {
        if (gameState.turnIdx === 0) return;
        if (wall.length > 0) { wall.shift(); pool.push({n: "‰∏≠", s: "Â≠ó"}); }
        let next = (gameState.turnIdx + 1) % 4;
        updateGame({ pool, wall, turnIdx: next, phase: "draw" });
        if (next !== 0) setTimeout(aiCycle, 600);
    }

    function updateGame(obj) {
        if (isMulti) db.ref('rooms/' + roomID).update(obj);
        else { Object.assign(gameState, obj); updateUI(); }
    }

    function getHTML(t) {
        let color = t.s==="Á≠í"?"c-blue":t.s==="Ê¢ù"?"c-green":"c-red";
        return `<div class="tile-content ${color}"><span class="char-top">${t.n}</span><span class="char-bottom">${(t.s==="Â≠ó"||t.s==="Ëä±")?"":t.s}</span></div>`;
    }

    function renderHand() {
        const h = document.getElementById('my-hand'); h.innerHTML = "";
        myTiles.forEach((t, i) => {
            const d = document.createElement('div');
            d.className = `tile` + (selectedIdx === i ? ' selected' : '');
            if (t.s === "Ëä±") d.style.border = "1px solid #ff0"; // Ëä±ÁâåÁâπÂà•Ê®ôÁ§∫
            d.innerHTML = getHTML(t); d.onclick = () => handleTileClick(i); h.appendChild(d);
        });
    }

    function renderPool() {
        const p = document.getElementById('pool'); p.innerHTML = "";
        pool.forEach(t => {
            const d = document.createElement('div'); d.className = "tile"; d.innerHTML = getHTML(t); p.appendChild(d);
        });
        p.scrollTop = p.scrollHeight;
    }

    function addBtn(txt, fn, cls="") {
        const b = document.createElement('button'); b.className = "btn-act " + cls; b.innerText = txt; b.onclick = fn; document.getElementById('action-bar').appendChild(b);
    }
</script>
</body>
</html>
