<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Woody éº»å°‡ - çµ‚æ¥µç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --green: #1a4a16; --tile-w: 42px; --tile-h: 58px; }
        body { margin: 0; background: #000; color: white; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; touch-action: none; }
        
        #game-ui { width: 100vw; height: 100vh; background: radial-gradient(circle, #265c21 0%, #1a4a16 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .table { width: 92%; height: 70%; border: 10px solid #4a3219; background: #265c21; border-radius: 30px; position: relative; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        
        /* æ‰‹ç‰Œæ¨£å¼ */
        .hand { display: flex; gap: 2px; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .tile { 
            width: var(--tile-w); height: var(--tile-h); 
            background: linear-gradient(to bottom, #eee 0%, #fff 100%); 
            border-radius: 4px; color: #000; 
            display: flex; justify-content: center; align-items: center; 
            font-weight: bold; font-size: 18px; 
            box-shadow: 0 4px 0 #bbb, 0 6px 10px rgba(0,0,0,0.4);
            cursor: pointer; transition: transform 0.1s;
            border: 1px solid #ccc;
        }
        .tile:active { transform: translateY(-10px); background: #ffffd0; }
        
        /* è¬ç­’æ¢é¡è‰²å€åˆ† */
        .tile[data-suit="è¬"] { color: #d32f2f; }
        .tile[data-suit="æ¢"] { color: #2e7d32; }
        .tile[data-suit="ç­’"] { color: #1565c0; }
        .tile[data-suit="å­—"] { color: #333; }

        #lobby { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .box { background: white; color: #333; padding: 30px; border-radius: 20px; text-align: center; width: 280px; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="box">
        <h1 style="color:#1a4a16">ğŸ€„ Woody éº»å°‡</h1>
        <input type="text" id="room" placeholder="è¼¸å…¥æˆ¿è™Ÿ (å¦‚ 888)">
        <input type="text" id="user" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±">
        <button onclick="start()">é–‹å§‹ Woody ç‰Œå±€</button>
    </div>
</div>

<div id="game-ui">
    <div style="margin-bottom:10px;">
        æˆ¿è™Ÿ: <span id="r-id" style="color:#ffeb3b">--</span> | ç©å®¶: <span id="p-count" style="color:#ffeb3b">0/4</span>
    </div>
    <div class="table">
        <div id="last-tile-display" style="font-size: 40px; background: white; color: black; padding: 20px; border-radius: 10px; display: none; box-shadow: 0 0 20px yellow;"></div>
        <div class="hand" id="my-hand"></div>
    </div>
    <div id="status" style="margin-top:15px; background:rgba(0,0,0,0.5); padding:5px 20px; border-radius:20px;">ç­‰å¾…é–‹æ¡Œ...</div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDJ1jofbDz5jx1W1UAmBfqdAeCR-YUGMEQ",
        databaseURL: "https://mj-game-85703-default-rtdb.firebaseio.com",
        projectId: "mj-game-85703",
        appId: "1:221004505436:web:64a9569766627038e2343b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function createFullDeck() {
        const suits = ["è¬", "ç­’", "æ¢"];
        const nums = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹"];
        const honors = ["æ±", "å—", "è¥¿", "åŒ—", "ä¸­", "ç™¼", "ç™½"];
        let deck = [];
        suits.forEach(s => nums.forEach(n => { for(let i=0;i<4;i++) deck.push({n, s}); }));
        honors.forEach(h => { for(let i=0;i<4;i++) deck.push({n: h, s: "å­—"}); });
        return deck.sort(() => Math.random() - 0.5);
    }

    function start() {
        const rid = document.getElementById('room').value;
        const name = document.getElementById('user').value;
        if(!rid || !name) return alert("è«‹å¡«å¯«æˆ¿è™Ÿèˆ‡æš±ç¨±ï¼");

        document.getElementById('lobby').style.display = 'none';
        document.getElementById('r-id').innerText = rid;

        const deck = createFullDeck();
        const myHand = deck.slice(0, 13);
        const ref = db.ref('rooms/' + rid);

        ref.set({
            players: [{name: name, hand: myHand}, {name:"é›»è…¦A"}, {name:"é›»è…¦B"}, {name:"é›»è…¦C"}],
            lastPlayed: "æ­¡è¿ä¾†åˆ° Woody ç‰Œå±€ï¼",
            status: "playing"
        });

        ref.on('value', snap => {
            const data = snap.val();
            if(!data) return;
            document.getElementById('p-count').innerText = data.players.length + "/4";
            document.getElementById('status').innerText = data.lastPlayed;
            
            if(data.currentTile) {
                const display = document.getElementById('last-tile-display');
                display.innerText = data.currentTile;
                display.style.display = 'block';
            }
            drawUI(myHand, rid, name);
        });
    }

    function drawUI(hand, rid, name) {
        const container = document.getElementById('my-hand');
        container.innerHTML = "";
        
        // æ’åºæ‰‹ç‰Œ
        hand.sort((a,b) => a.s.localeCompare(b.s) || a.n.localeCompare(b.n));

        hand.forEach((tile, index) => {
            const div = document.createElement('div');
            div.className = 'tile';
            div.innerText = tile.n + (tile.s === "å­—" ? "" : tile.s);
            div.setAttribute('data-suit', tile.s);
            
            div.onclick = () => {
                if(confirm(`ç¢ºå®šæ‰“å‡º ${tile.n}${tile.s === "å­—" ? "" : tile.s}ï¼Ÿ`)) {
                    db.ref('rooms/' + rid).update({
                        lastPlayed: `${name} æ‰“å‡ºäº† ${tile.n}${tile.s === "å­—" ? "" : tile.s}`,
                        currentTile: tile.n + (tile.s === "å­—" ? "" : tile.s)
                    });
                    hand.splice(index, 1);
                    drawUI(hand, rid, name);
                }
            };
            container.appendChild(div);
        });
    }
</script>
</body>
</html>
