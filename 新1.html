<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Woody éº»å°‡ - å°ˆæ¥­å›åˆç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --green: #1a4a16; --tile-w: 38px; --tile-h: 52px; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        #game-ui { width: 100vw; height: 100vh; background: radial-gradient(circle, #265c21 0%, #1a4a16 100%); display: flex; flex-direction: column; align-items: center; }
        
        .table { width: 90%; height: 60%; border: 8px solid #4a3219; background: #265c21; border-radius: 20px; position: relative; margin-top: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; padding: 15px; overflow-y: auto; }
        
        /* ç‰Œæ± è£¡çš„ç‰Œ */
        .pool-tile { width: 30px; height: 42px; background: white; color: black; border-radius: 3px; margin: 2px; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: bold; border: 1px solid #999; }
        
        .hand { display: flex; gap: 2px; position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; }
        .tile { width: var(--tile-w); height: var(--tile-h); background: white; border-radius: 4px; color: black; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; cursor: pointer; border: 1px solid #ccc; box-shadow: 0 3px 0 #bbb; }
        .tile.my-turn { border: 2px solid #ffeb3b; box-shadow: 0 0 10px #ffeb3b; }
        
        #lobby { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .box { background: white; color: #333; padding: 30px; border-radius: 20px; text-align: center; width: 280px; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="box">
        <h1>ğŸ€„ Woody éº»å°‡</h1>
        <input type="text" id="room" placeholder="æˆ¿è™Ÿ" style="width:80%; padding:10px; margin-bottom:10px;">
        <input type="text" id="user" placeholder="ä½ çš„æš±ç¨±" style="width:80%; padding:10px;">
        <button onclick="start()">é€²å…¥éŠæˆ²</button>
    </div>
</div>

<div id="game-ui">
    <div style="margin-top:10px;">
        æˆ¿è™Ÿ: <span id="r-id" style="color:yellow">--</span> | 
        <span id="turn-display" style="background:red; padding:2px 10px; border-radius:5px;">ç­‰å¾…ä¸­</span>
    </div>
    
    <div class="table" id="pool"></div>

    <div class="hand" id="my-hand"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDJ1jofbDz5jx1W1UAmBfqdAeCR-YUGMEQ",
        databaseURL: "https://mj-game-85703-default-rtdb.firebaseio.com",
        projectId: "mj-game-85703",
        appId: "1:221004505436:web:64a9569766627038e2343b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myName = "";
    let myRoom = "";
    let myTiles = [];

    function createDeck() {
        const suits = ["è¬", "ç­’", "æ¢"];
        const nums = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹"];
        const honors = ["æ±", "å—", "è¥¿", "åŒ—", "ä¸­", "ç™¼", "ç™½"];
        let deck = [];
        suits.forEach(s => nums.forEach(n => { for(let i=0;i<4;i++) deck.push(n+s); }));
        honors.forEach(h => { for(let i=0;i<4;i++) deck.push(h); });
        return deck.sort(() => Math.random() - 0.5);
    }

    function start() {
        myRoom = document.getElementById('room').value;
        myName = document.getElementById('user').value;
        if(!myRoom || !myName) return alert("è«‹è¼¸å…¥å®Œæ•´ï¼");

        document.getElementById('lobby').style.display = 'none';
        document.getElementById('r-id').innerText = myRoom;

        const deck = createDeck();
        myTiles = deck.slice(0, 13).sort();

        // åˆå§‹åŒ–æˆ¿é–“
        db.ref('rooms/' + myRoom).set({
            pool: [],
            currentTurn: myName, // é è¨­ç¬¬ä¸€æ‰‹æ˜¯è‡ªå·±
            status: "playing"
        });

        // ç›£è½æˆ¿é–“è®ŠåŒ–
        db.ref('rooms/' + myRoom).on('value', snap => {
            const data = snap.val();
            if(!data) return;

            // æ›´æ–°ç‰Œæ± 
            const poolDiv = document.getElementById('pool');
            poolDiv.innerHTML = "";
            if(data.pool) {
                data.pool.forEach(t => {
                    const d = document.createElement('div');
                    d.className = 'pool-tile';
                    d.innerText = t;
                    poolDiv.appendChild(d);
                });
            }

            // æ›´æ–°å›åˆé¡¯ç¤º
            const isMyTurn = data.currentTurn === myName;
            const turnDisplay = document.getElementById('turn-display');
            turnDisplay.innerText = isMyTurn ? "è¼ªåˆ°ä½ å‡ºç‰Œ" : "ç­‰å¾…ä»–äºº...";
            turnDisplay.style.background = isMyTurn ? "#28a745" : "#555";

            drawUI(isMyTurn);
        });
    }

    function drawUI(canPlay) {
        const container = document.getElementById('my-hand');
        container.innerHTML = "";
        myTiles.forEach((t, index) => {
            const div = document.createElement('div');
            div.className = 'tile' + (canPlay ? ' my-turn' : '');
            div.innerText = t;
            div.onclick = () => {
                if(!canPlay) return alert("é‚„æ²’è¼ªåˆ°ä½ å–”ï¼");
                playTile(t, index);
            };
            container.appendChild(div);
        });
    }

    function playTile(tile, index) {
        myTiles.splice(index, 1); // å¾æ‰‹ç‰Œç§»é™¤
        
        const ref = db.ref('rooms/' + myRoom);
        ref.once('value', snap => {
            const data = snap.val();
            let newPool = data.pool || [];
            newPool.push(tile); // åŠ å…¥ç‰Œæ± 
            
            // æ›´æ–°åˆ°è³‡æ–™åº«ï¼Œä¸¦åˆ‡æ›å›åˆçµ¦ã€Œé›»è…¦Aã€
            ref.update({
                pool: newPool,
                currentTurn: "é›»è…¦A" 
            });
            
            // æ¨¡æ“¬é›»è…¦è‡ªå‹•å‡ºç‰Œï¼ˆ3ç§’å¾Œï¼‰
            setTimeout(() => {
                ref.update({ currentTurn: myName });
            }, 3000);
        });
    }
</script>
</body>
</html>
